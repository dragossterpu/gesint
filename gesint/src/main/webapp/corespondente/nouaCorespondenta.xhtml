<ui:composition template="../layouts/layoutInterior2.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui">
	<ui:define name="content">
		<h:form id="form">
			<div class="blocFormular">
				<p:panel header="Creați o corespndență nouă" styleClass="panelModCard">
					<div class="container-fluid">
						<div class="blocFormular">
							<p:dataTable var="utilizator" value="#{corespondentaBean.utilizatoriSelectionatiFinali}" id="tablaUsueriosSeleccionados" rows="5" 
							paginator="true" paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                 			rowsPerPageTemplate="5,10,15" resizableColumns="true" pageLinks="5" paginatorAlwaysVisible="false" 
								rendered="#{not empty corespondentaBean.utilizatoriSelectionatiFinali}" rowKey="#{utilizator.username}">
								<f:facet name="header">Membrii cărora li se va trimite corespondența via EMAIL</f:facet>
								<p:column headerText="EMAIL" style="width:60%;">
									<h:outputText value="#{utilizator.username}" />
								</p:column>
								<p:column headerText="CANAL DE COMUNICARE" style="width:25%;" styleClass="text-center">
									<h:outputText value="#{utilizator.canalCorespondenta}" />
								</p:column>
								<p:column styleClass="butonTabla text-center" exportable="false"
									toggleable="false" style="width:5%;">
									<p:commandButton title="Eliminare" icon="fa fa-trash" styleClass="modBtn"
										actionListener="#{corespondentaBean.eliminareUtilizator(utilizator)}"
										update="form" immediate="true" />
								</p:column>
								<f:facet name="footer">
									Total:	#{corespondentaBean.utilizatoriSelectionatiFinali.size()} destinatari ai corespondenței
   							</f:facet>
							</p:dataTable>
							<div class="ui-g">
								<p:outputPanel rendered="#{empty corespondentaBean.utilizatoriSelectionatiFinali}" class="ui-g-2">
									<b><h:outputLabel for="destinatar" value="* Destinatar:" /></b>
								</p:outputPanel>
								<p:outputPanel rendered="#{empty corespondentaBean.utilizatoriSelectionatiFinali}" class="ui-g-6">
									<p:inputText id="destinatar" ajax="true" value="#{corespondentaBean.numeUtilizator}"
										required="#{empty corespondentaBean.numeUtilizator or empty corespondentaBean.utilizatoriSelectionatiFinali}"
										requiredMessage="Trebuie să introduceți un destinatar pentru corespondență."
										validatorMessage="Format e-mail nevalid.">
										<f:validateRegex
											pattern="^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$" />
									</p:inputText>
									<p:message for="destinatar" display="tooltip" />
								</p:outputPanel>
								<div class="ui-g-4">
									<p:commandButton value="Căutați" icon="fa fa-search"
										action="#{corespondentaBean.deschideDialogCautareUtilizatori}"
										immediate="true" onstart="PF('statusDialog').show()"
										onsuccess="PF('statusDialog').hide()" update="formCautatorUtilizatori"/>
								</div>
							</div>							
							<div class="ui-g">
								<div class="ui-g-2">
									<b><h:outputLabel for="tipSelect" value="* Tipul corespondenței:" /></b>
								</div>
								<div class="ui-g-12 ui-md-6 ui-lg-4">
									<p:importEnum type="ro.stad.online.gesint.persistence.entities.enums.CategorieEnum"
										var="tip" allSuffix="ALL_ENUM_VALUES" />
									<p:selectOneMenu value="#{corespondentaBean.corespondenta.tipCorespondenta}"
										id="tipSelect"
										required="true" requiredMessage="Alegeți un tip de corespondență" styleClass="form-control form-select">
										<f:selectItem itemLabel="Alege un un tip" itemValue="" />
										<f:selectItems value="#{tip.ALL_ENUM_VALUES}" var="tip"
											itemLabel="#{tip.description}" itemValue="#{tip}" />
									</p:selectOneMenu>							
								</div>
							</div>
							<div class="ui-g">
								<div class="ui-g-2">
									<b><h:outputLabel for="titlu" value="* Subiect:" /></b>
								</div>
								<div class="ui-g-10">
									<p:inputText id="titlu" value="#{corespondentaBean.corespondenta.titlu}"
										required="true"
										requiredMessage="Trebuie să introduceți un subiect pentru corespondență." />
									<p:messages for="titlu" autoUpdate="true" closable="true" />
								</div>
							</div>
							<div class="ui-g">
								<div class="ui-g-2">
									<b><h:outputLabel for="nume" value="* Descriere:" /></b>
								</div>
								<div class="ui-g-10">
									<p:inputTextarea id="nume" rows="6" cols="150"maxlength="200" autoResize="false"
										value="#{corespondentaBean.corespondenta.descriere}" required="true"
										requiredMessage="Trebuie să introduceți o descriere a corespondenței."
										converter="#{trimConverter}"
										validatorMessage="Descrierea trebuie să aibă mai mult de 10 caractere.">
										<f:validateLength minimum="10" />
									</p:inputTextarea>
									<p:messages for="nume" autoUpdate="true" closable="true" />
								</div>
							</div>
							<div class="ui-g">
								<div class="ui-g-2">
									<b><h:outputLabel for="auto" value="Trimitere automatică a corespondenței" /></b>
								</div>
								<div class="ui-g-10" id ="auto">
									 <p:selectBooleanCheckbox value="#{corespondentaBean.corespondenta.automatic}"/>
									<p:messages for="auto" autoUpdate="true" closable="true" />
								</div>
							</div>
							<div class="ui-g">
								<div class="ui-g-2">
									<b><h:outputLabel for="dataTrimiteri" value="Alegeți data trimiterii automatice a corespondenței:" /></b>
								</div>
								<div class="ui-g-12 ui-md-6 ui-lg-4">
									<p:calendar id="dataTrimiteri" pattern="dd/MM/yyyy" locale="es"
										navigator="true"  mindate="#{corespondentaBean.currentDate}"
										value="#{corespondentaBean.corespondenta.dataTrimiteri}" />
									<p:messages for="dataTrimiteri" autoUpdate="true" closable="true" />
								</div>
							</div>
							<div class="ui-g">
								<p:dataTable id="tablaDocumente" var="document" value="#{corespondentaBean.documenteIncarcate}" editable="true" onkeypress="if (event.keyCode == 13) {return false; }" emptyMessage="Nu sunt încărcate documente.">
			                        <p:ajax event="rowEdit" listener="#{corespondentaBean.onRowEdit}" />
			
			                        <p:column headerText="Documentele încărcate">
			                            <h:outputText value="#{document.nume}" />
			                        </p:column>
			                        <p:column styleClass="butonTabla">
			                            <p:commandButton icon="fa fa-fw fa-download" ajax="false" actionListener="#{corespondentaBean.descarcareFisier(document)}" title="Descărcați documentul">
			                                <p:fileDownload value="#{corespondentaBean.file}" />
			                            </p:commandButton>
			                        </p:column>
			                        <p:column styleClass="butonTabla" >
			                            <p:commandButton title="Elimină" icon="fa fa-trash" actionListener="#{corespondentaBean.eliminareDocumentFinal(document)}" update=":form tablaDocumente">
			                                <p:confirm header="Ștergeți documentul" message="Sigur doriți să ștergeți acest document?" icon="fa fa-warning-sign" />
			                            </p:commandButton>
			                        </p:column>	
	                    		</p:dataTable>
                    	</div>
						</div>
					</div>
				</p:panel>
				<div class="aclaratii2">Butonul "Trimiteți email" trimite corespondența electronică și salvează comunicarea în baza de date.</div>
				<div class="aclaratii2">Butonul "Salvați corespondență" NUMAI salvează corespondența în baza de date fără a o trimite.</div>
				<div class="butoaneFormular">
					<p:button outcome="/corespondente/corespondente" value="Renunţare"
						icon="fa fa-fw fa-undo" />
					<p:commandButton action="#{corespondentaBean.deschideDialogIncarcarDocument()}"  
					value="Atașați documente" icon="fa fa-plus" />
					<p:commandButton action="#{corespondentaBean.trimiteCorespondenta}"
						value="Trimiteți email" update="form" icon="fa fa-send"
						onstart="PF('statusDialog').show()"
						onsuccess="PF('statusDialog').hide()" />
					<p:commandButton action="#{corespondentaBean.salvareCorespondenta}" outcome="/corespondente/corespondente"
						value="Salvați corespondența" update="form" icon="fa fa-send"
						onstart="PF('statusDialog').show()" 
						onsuccess="PF('statusDialog').hide()" />
				</div>
			</div>					
			<p:dialog widgetVar="statusDialog" modal="true" draggable="false"
				closable="false" resizable="false" showHeader="false">
				<p:graphicImage value="/images/loading.gif" />
			</p:dialog>
		</h:form>
		<h:form id="formCautatorUtilizatori">
			<p:dialog header="Căutare destinatari pentru trimitere via EMAIL" widgetVar="dialogCautare"
						dynamic="true" width="800" height="500">
				<p:panelGrid columns="1" id="panouCautareUtilizatori">
					<p:selectOneButton value="#{corespondentaBean.opcion}">
						<p:ajax event="change" update="formCautatorUtilizatori:panouCautareUtilizatori" listener="#{corespondentaBean.curatareFiltre}" />
						<f:selectItem itemLabel="Membrii" itemValue="1" />
						<f:selectItem itemLabel="Conducere locală" itemValue="2" />
						<f:selectItem itemLabel="Echipa de conducere centrală" itemValue="3" />
						<f:selectItem itemLabel="Destinatar extern sistem" itemValue="4" />
					</p:selectOneButton>				
					<p:panelGrid id="flansaUtilizatori" columns="2">					
						<p:panelGrid id="filtruUtilizatri" columns="2" rendered="#{corespondentaBean.opcion == 1}">
							<h:outputLabel for="numeUtilizator" styleClass="dialogLabel" value="Nume:" />
							<p:inputText id="numeUtilizator" value="#{corespondentaBean.filtruUtilizator.nume}" />
							<h:outputLabel for="prenumeUser" styleClass="dialogLabel" value="Prenume:" />
							<p:inputText id="prenumeUser" value="#{corespondentaBean.filtruUtilizator.prenume}" />
							<h:outputLabel for="judeteSelectate" styleClass="dialogLabel" value="Organizația/Județul:" />
							 <p:selectOneMenu    value="#{corespondentaBean.filtruUtilizator.idJudet}"  id="judeteSelectate" class="selectFiltru" >
	                        <f:selectItem itemLabel="Alege una..." itemValue="" />
	                        <f:selectItems  value="#{corespondentaBean.judete}"  var="provincia" itemLabel="#{provincia.nume}"  itemValue="#{provincia.indicator}" />                        
	                      </p:selectOneMenu>							              
						</p:panelGrid>
						<p:panelGrid id="filtruUtilizatoriCC" columns="2" rendered="#{corespondentaBean.opcion == 2}">
							<h:outputLabel for="numeUtilizatorCL" styleClass="dialogLabel" value="Nume:" />
							<p:inputText id="numeUtilizatorCL" value="#{corespondentaBean.filtruUtilizator.nume}" />
							<h:outputLabel for="prenumeUserCL" styleClass="dialogLabel" value="Prenume:" />
							<p:inputText id="prenumeUserCL" value="#{corespondentaBean.filtruUtilizator.prenume}" />
							<h:outputLabel for="judeteSelectateCL" styleClass="dialogLabel" value="Organizația/Județul:" />
							 <p:selectOneMenu  value="#{corespondentaBean.filtruUtilizator.idJudet}"  id="judeteSelectateCL" class="selectFiltru" >
	                        <f:selectItem itemLabel="Alege una..." itemValue="" />
	                        <f:selectItems  value="#{corespondentaBean.judete}"  var="provincia" itemLabel="#{provincia.nume}"  itemValue="#{provincia.indicator}" />                        
	                    </p:selectOneMenu>								
							<h:outputLabel for="teamUserCl" styleClass="dialogLabel" value="Funcția:" />
							<p:selectOneMenu value="#{corespondentaBean.filtruUtilizator.idFunctia}" filter="true" 
								filterMatchMode="startsWith" id="teamUserCl" class="selectFiltru" style="min-width:initial;" >
								<f:selectItem itemLabel="Alege una..." itemValue="" />
								<f:selectItems value="#{corespondentaBean.listaFunctiiLocal}"
									var="team"
									itemLabel="#{team.nume}"
									itemValue="#{team.id}" />
							</p:selectOneMenu>	                   
						</p:panelGrid>
						<p:panelGrid id="filtruUtilizatriExternos" columns="2" rendered="#{corespondentaBean.opcion == 4}">
								<div class="aclaratii2">Se pot introduce mai mulți destinatari separați prin virgulă (Ex: destinatar@exemplu.com, destinatar2@exemplu.com).</div>
								<p:outputPanel rendered="#{corespondentaBean.opcion == 3}" >
									<h:outputLabel for="userExtern" value="* Destinatar extern PARTID:" />
								</p:outputPanel>
								<p:outputPanel rendered="#{corespondentaBean.opcion == 4}" class="ui-g-10" >
									<p:inputText id="userExtern" ajax="true" value="#{corespondentaBean.utilizatorExtern}" class="ui-g-2"
										required="#{empty corespondentaBean.utilizatorExtern}"
										requiredMessage="Trebuie să introduceți un destinatar extern pentru corespondență.">
									</p:inputText>
									<p:message for="userExtern" display="tooltip" />
								</p:outputPanel>
						</p:panelGrid>
						
						
						 <p:commandButton action="#{corespondentaBean.cautareUtilizatori()}" rendered="#{corespondentaBean.opcion == 1}"
							value="Căutați" icon="fa fa-search"
							update=":formCautatorUtilizatori:tablaUtilizatori"
							onstart="PF('statusDialog').show()"
							onsuccess="PF('statusDialog').hide()" />
						 <p:commandButton action="#{corespondentaBean.cautareUtilizatori()}" rendered="#{corespondentaBean.opcion == 2}"
							value="Căutați" icon="fa fa-search"
							update=":formCautatorUtilizatori:tablaUtilizatoriCL"
							onstart="PF('statusDialog').show()"
							onsuccess="PF('statusDialog').hide()" />
						
						<p:dataTable var="utilizator" value="#{corespondentaBean.modelUser}" rendered="#{corespondentaBean.opcion == 1}" rows="10" id="tablaUtilizatori" 
						paginator="true" lazy="true" resizableColumns="true"  sortOrder="descending" styleClass="modHeaderTable"
						paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" 
						rowKey="#{utilizator.username}" rowsPerPageTemplate="5,10,25" pageLinks="4" paginatorPosition="bottom"
						emptyMessage="Nu există niciun rezultat care să corespundă parametrilor căutării dvs." paginatorAlwaysVisible="false">
							<p:ajax event="page" listener="#{corespondentaBean.schimbarePaginaUtilizatori()}" />
							<p:ajax event="rowUnselectCheckbox" listener="#{corespondentaBean.onRowUnSelectedUser}" />
							<p:ajax event="rowSelectCheckbox" listener="#{corespondentaBean.onRowSelectedUser}" />
							<p:ajax event="toggleSelect" listener="#{corespondentaBean.onToggleSelectUsers}" global="true" />							
							<p:column selectionMode="multiple"
								style="width:16px;text-align:center" />
							<p:column headerText="Nume" width="150">										
								<h:outputText value="#{utilizator.numeComplet}" />
							</p:column>
							<f:facet name="footer">
      				 				Total: #{corespondentaBean.modelUser.rowCount} membrii găsiți.
   							</f:facet>
						</p:dataTable>	
					
						
						<p:dataTable var="utilizatorCL" value="#{corespondentaBean.listUsersLocal}" rendered="#{corespondentaBean.opcion == 2}" rows="10" id="tablaUtilizatoriCL" 
						paginator="true" lazy="true" resizableColumns="true"  sortOrder="descending" styleClass="modHeaderTable"
						paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" 
						rowKey="#{utilizatorCL.username}" rowsPerPageTemplate="5,10,25" pageLinks="4" paginatorPosition="bottom"
						emptyMessage="Nu există niciun rezultat care să corespundă parametrilor căutării dvs." paginatorAlwaysVisible="false">
							<p:ajax event="page" listener="#{corespondentaBean.schimbarePaginaUtilizatori()}" />
							<p:ajax event="rowUnselectCheckbox" listener="#{corespondentaBean.onRowUnSelectedUser}" />
							<p:ajax event="rowSelectCheckbox" listener="#{corespondentaBean.onRowSelectedUser}" />
							<p:ajax event="toggleSelect" listener="#{corespondentaBean.onToggleSelectUsersCL}" global="true" />							
							<p:column selectionMode="multiple"
								style="width:16px;text-align:center" />
							<p:column headerText="Nume" width="150">										
								<h:outputText value="#{utilizatorCL.numeComplet}" />
							</p:column>
							<f:facet name="footer">
      				 				Total: #{corespondentaBean.rowCountLocal} membrii din conducerea locală găsiți.
   							</f:facet>
						</p:dataTable>	
											
						<p:dataTable var="team" value="#{corespondentaBean.listUsersCentral}" rendered="#{corespondentaBean.opcion == 3}" rows="10" id="tablaTeam" 
						paginator="true" lazy="true" resizableColumns="true"  sortOrder="descending" styleClass="modHeaderTable"
						paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" 
						rowKey="#{team.username}" rowsPerPageTemplate="5,10,25" pageLinks="4" paginatorPosition="bottom"
						emptyMessage="Nu există niciun rezultat care să corespundă parametrilor căutării dvs." paginatorAlwaysVisible="false">
							<p:ajax event="page" listener="#{corespondentaBean.schimbarePaginaUtilizatori()}" />
							<p:ajax event="rowUnselectCheckbox" listener="#{corespondentaBean.onRowUnSelectedUser}" />
							<p:ajax event="rowSelectCheckbox" listener="#{corespondentaBean.onRowSelectedUser}" />
							<p:ajax event="toggleSelect" listener="#{corespondentaBean.onToggleSelectTeam}" global="true" />							
							<p:column selectionMode="multiple"
								style="width:16px;text-align:center" />							
							<p:column headerText="Nume" width="150">										
								<h:outputText value="#{team.numeComplet}" />
							</p:column>							
							<f:facet name="footer">
      				 				Total: #{corespondentaBean.rowCountCentral} membrii în conducerea centrală a partidului.
   							</f:facet>
						</p:dataTable>
					</p:panelGrid>
					<p:outputPanel class="btnModalAcept">
						<p:commandButton value="Acceptați" onclick="PF('dialogCautare').hide()" update="form" actionListener="#{corespondentaBean.stabilireUtilizatoriFinali}"/>
					</p:outputPanel>
				</p:panelGrid>	
			</p:dialog>
			<p:dialog id="dialog" widgetVar="dialogMessage" header="INFO"
				closable="false" resizable="false" modal="true">
				<p:messages for="dialogMessage" autoUpdate="true"
					showDetail="true" showSummary="true" />
				<p:commandButton value="Acceptați 2"
					onclick="PF('dialogMessage').hide()" outcome="/corespondente/corespondente" styleClass="right" />
			</p:dialog>
		</h:form>
				<h:form id="formIncarcareDocumente">
				<p:dialog header="Atașați documente corespondenței electronice" widgetVar="dlgIncarcareDocument" dynamic="true" width="800" height="800">
				<div class="aclaratii">Se acceptă documentele care coincid ca nume și extensie cu documentele încărcate.</div>
				<div class="blocView">
		            <p:dataTable id="tablaDoc" var="document" value="#{corespondentaBean.documenteIncarcate}">
		                <p:column headerText="DOCUMENT" width="50%">
		                    <h:outputText value="#{document.descriere}" />
		                </p:column>
		                <p:column headerText="NUME" width="50%">
		                    <h:outputText value="#{document.nume}" />
		                </p:column>
		            </p:dataTable>
		        </div>
		       <p:separator />
		        <div class="aclaratii2">
		            (1).- Pentru fiecare tip de document, unul sau mai multe documente pot fi încărcate simultan. 
		            <strong>Dacă oricare dintre ele este alcătuită din două sau mai multe părți, numele lor trebuie să înceapă cu numele documentului respectiv și un număr secvențial 
		            </strong> (ex: organigrama_1.doc, organigrama_2.doc). Dimensiunea maximă per fișier încărcat este de 20 MB.
		        </div>
		                <div class="blocView">

                <p:fileUpload width="50%" cancelLabel="ANULARE" label="SELECTAREA DOCUMENTULUI" uploadLabel="ÎNCĂRCARE DOCUMENTE" 
                fileUploadListener="#{corespondentaBean.gestioneazaIncarcareDocument}" mode="advanced" dragDropSupport="false" 
                sizelimit="20971520" multiple="true" update=":formIncarcareDocumente:panouAtasament tablaDocumente" autofileLimit="30" 
                allowTypes="/(\.|\/)(jpe?g|png|bmp|doc|docx|pptx|ppt|pub|xls|xlsx|pdf)$/i" sequential="true" />				
                <p:outputPanel id="panouAtasament">
                    <p:dataTable id="tablaDocumente" var="document" value="#{corespondentaBean.listaDocumente}" editable="true" onkeypress="if (event.keyCode == 13) {return false; }" emptyMessage="Nu sunt încărcate documente.">
                        <p:ajax event="rowEdit" listener="#{corespondentaBean.onRowEdit}" update=":formIncarcareDocumente:msgs" />

                        <p:column headerText="Documentele încărcate">
                            <h:outputText value="#{document.nume}" />
                        </p:column>
                        <p:column styleClass="butonTabla">
                            <p:commandButton icon="fa fa-fw fa-download" ajax="false" actionListener="#{corespondentaBean.descarcareFisier(document)}" title="Descărcați documentul">
                                <p:fileDownload value="#{corespondentaBean.file}" />
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="butonTabla" >
                            <p:commandButton title="Elimină document" icon="fa fa-trash" action="#{corespondentaBean.eliminareDocument(document)}" update=":formIncarcareDocumente:panouAtasament tablaDocumente">
                                <p:confirm header="Ștergeți documentul" message="Sunteți sigur că doriți să eliminați acest document?" icon="fa fa-warning-sign" />
                            </p:commandButton>
                        </p:column>

                    </p:dataTable>
                    <p:outputPanel class="btnModalAcept">
						<p:commandButton value="Acceptați și încărcați doocumentele în alertă/comunicare " onclick="PF('dlgIncarcareDocument').hide()" update=":form tablaDocumente" actionListener="#{corespondentaBean.incarcareDocument}"/>
					</p:outputPanel>
                </p:outputPanel>
                	
                <p:confirmDialog global="true">
                    <div class="centrareButoaneDialog">
                        <p:commandButton value="Acceptați" type="button" styleClass="ui-confirmdialog-yes" icon="fa fa-check" />
                        <p:commandButton value="Anulați" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-remove" />
                    </div>
                </p:confirmDialog>
                <div class="butoaneFormular">
                    <p:button outcome="/corespondente/corespondente" value="Înapoi" icon="fa fa-fw fa-undo" />
                </div>
                <p:messages id="msgs" autoUpdate="true" closable="true" showDetail="true" />
        </div>				
			</p:dialog>
		</h:form>
	</ui:define>
</ui:composition>